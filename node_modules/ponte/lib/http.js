
var express = require("express");
var http = require("http");
var resourcesRegexp = /^\/resources(\/.+)$/;
var callback = require("callback-stream");
var bunyanExpress = require("./bunyanExpress");
var Route = require('route-parser');

var route = new Route('/device/:device/key/:key');
var validate = require('jsonschema').validate;

var tryParseJson = function(str) {
  try {
    return JSON.parse(str);
  } catch (ex) {
    return null;
  }
};

function HTTP(opts, done) {
  if (!(this instanceof HTTP)) {
    return new HTTP(opts, done);
  }

  if (typeof opts === "function") {
    cb = opts;
    opts = {};
  }

  var that = this;
  this._persistence = opts.ponte.persistence;
  this._ponte = opts.ponte;
  var logger = this._logger = opts.ponte.logger.child({ service: 'HTTP' });
  this.server = http.createServer(this.express(opts));
  this.server.listen(opts.port, function(err) {
    done(err, that);
    logger.info({ port: opts.port }, "server started");
  });
}

HTTP.prototype.close = function(done) {
  this.server.close(done);
};

HTTP.prototype.express = function(opts) {
  var app = express();
  var that = this;

  app.use(bunyanExpress.logger(this._logger));
  app.use(bunyanExpress.errorLogger(this._logger));

  app.get(resourcesRegexp, function(req, res){
    var topic = req.params[0];
    that._persistence.lookupRetained(topic, function(err, packets) {
      if (packets.length === 0) {
        res.send(404);
      } else {
        res.send(packets[0].payload);
      }
    });
    
  });

  app.put(resourcesRegexp, function(req, res) {
    var topic = req.params[0];
    req.pipe(callback(function(err, payload) {
      payload = payload.toString();

      var routeParams = route.match(topic);
      if(!routeParams.device || !routeParams.key) return res.send(400);

      var result = tryParseJson(payload);
      if(!result) return res.send(400);

      var arrayValidation = validate(result, {"$schema":"http://json-schema.org/draft-04/schema#","id":"/","type":"object","properties":{"sensors":{"id":"sensors","type":"array","items":{"id":"0","type":"object","properties":{"tag":{"id":"tag","type":"string"},"value":{"id":"value","type":"string"}},"additionalProperties":false,"required":["tag","value"]},"additionalItems":false,"required":["0"]}},"additionalProperties":false,"required":["sensors"]});
      var objectValidation = validate(result,{"$schema":"http://json-schema.org/draft-04/schema#","id":"/","type":"object","properties":{"tag":{"id":"tag","type":"string"},"value":{"id":"value","type":"string"}},"additionalProperties":false,"required":["tag","value"]});

      if(arrayValidation.errors.length !== 0 && objectValidation.errors.length !== 0 )  return res.send(400);

      var packet = { topic: topic, payload: payload, retain: true };
      that._persistence.storeRetained(packet, function() {
        opts.ponte.broker.publish(topic, payload, {}, function() {
          res.location('/resources' + topic);
          res.send(204);
          that._ponte.emit('updated', topic, new Buffer(payload));
        });
      });
    }));
  });

  return app;
};

module.exports = HTTP;
